"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.runSimulatorReset = runSimulatorReset;
exports.installToSimulator = installToSimulator;
exports.shutdownSimulator = shutdownSimulator;
exports.shutdownOtherSimulators = shutdownOtherSimulators;

require("source-map-support/register");

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumWebdriveragent = require("appium-webdriveragent");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _appiumSupport = require("appium-support");

var _desiredCaps = require("./desired-caps");

const APPIUM_SIM_PREFIX = 'appiumTest';

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const udid = await new _nodeSimctl.default().createDevice(`${APPIUM_SIM_PREFIX}-${_uuidJs.default.create().toString().toUpperCase()}-${caps.deviceName}`, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid, {
    platform,
    checkExistence: false
  });
}

async function getExistingSim(opts) {
  let appiumTestDevice;

  for (const device of _lodash.default.values((await new _nodeSimctl.default().getDevices(opts.platformVersion)))) {
    if (device.name === opts.deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid, {
        platform: device.platform,
        checkExistence: false
      });
    }

    if (device.name.startsWith(APPIUM_SIM_PREFIX) && device.name.endsWith(opts.deviceName)) {
      appiumTestDevice = device;

      if (device.state === 'Booted') {
        break;
      }
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${opts.deviceName}'. Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid, {
      platform: appiumTestDevice.platform,
      checkExistence: false
    });
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _appiumWebdriveragent.resetTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await device.simctl.terminateApp(opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, opts = {}) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  const {
    noReset = true,
    newSimulator = false
  } = opts;

  if (!newSimulator && bundleId && (await device.isAppInstalled(bundleId))) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

      return;
    }

    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

    await device.removeApp(bundleId);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    await device.installApp(app);
  } catch (e) {
    _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

    _logger.default.info('Retrying application install');

    await device.installApp(app);
  }

  _logger.default.debug('The app has been installed successfully.');
}

async function shutdownOtherSimulators(currentDevice) {
  const simctl = new _nodeSimctl.default();

  const allDevices = _lodash.default.flatMap(_lodash.default.values((await simctl.getDevices())));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running ${_appiumSupport.util.pluralize('Simulator', otherBootedDevices.length)}.` + `Shutting them down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _appiumWebdriveragent.resetTestProcesses)(udid, true);
    simctl.udid = udid;
    await simctl.shutdownDevice();
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJBUFBJVU1fU0lNX1BSRUZJWCIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwidWRpZCIsIlNpbWN0bCIsImNyZWF0ZURldmljZSIsIlVVSUQiLCJjcmVhdGUiLCJ0b1N0cmluZyIsInRvVXBwZXJDYXNlIiwiZGV2aWNlTmFtZSIsInBsYXRmb3JtVmVyc2lvbiIsImNoZWNrRXhpc3RlbmNlIiwiZ2V0RXhpc3RpbmdTaW0iLCJvcHRzIiwiYXBwaXVtVGVzdERldmljZSIsImRldmljZSIsIl8iLCJ2YWx1ZXMiLCJnZXREZXZpY2VzIiwibmFtZSIsInN0YXJ0c1dpdGgiLCJlbmRzV2l0aCIsInN0YXRlIiwibG9nIiwid2FybiIsInNodXRkb3duU2ltdWxhdG9yIiwic2h1dGRvd24iLCJydW5TaW11bGF0b3JSZXNldCIsIm5vUmVzZXQiLCJmdWxsUmVzZXQiLCJkZWJ1ZyIsImlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCIsImtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyIsImtlZXBLZXlDaGFpbnMiLCJiYWNrdXBLZXljaGFpbnMiLCJjbGVhbiIsInJlc3RvcmVLZXljaGFpbnMiLCJpbmZvIiwiYnVuZGxlSWQiLCJpc1J1bm5pbmciLCJlbmZvcmNlU2ltdWxhdG9yU2h1dGRvd24iLCJzaW1jdGwiLCJ0ZXJtaW5hdGVBcHAiLCJlcnIiLCJhcHAiLCJpc1NhZmFyaSIsImJyb3dzZXJOYW1lIiwidG9Mb3dlckNhc2UiLCJjbGVhblNhZmFyaSIsInNjcnViQ3VzdG9tQXBwIiwibWVzc2FnZSIsImluc3RhbGxUb1NpbXVsYXRvciIsIm5ld1NpbXVsYXRvciIsImlzQXBwSW5zdGFsbGVkIiwicmVtb3ZlQXBwIiwiaW5zdGFsbEFwcCIsImUiLCJzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyIsImN1cnJlbnREZXZpY2UiLCJhbGxEZXZpY2VzIiwiZmxhdE1hcCIsIm90aGVyQm9vdGVkRGV2aWNlcyIsImZpbHRlciIsImlzRW1wdHkiLCJsZW5ndGgiLCJ1dGlsIiwicGx1cmFsaXplIiwic2h1dGRvd25EZXZpY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxpQkFBaUIsR0FBRyxZQUExQjs7QUFlQSxlQUFlQyxTQUFmLENBQTBCQyxJQUExQixFQUFnQ0MsUUFBUSxHQUFHQyw4QkFBM0MsRUFBOEQ7QUFDNUQsUUFBTUMsSUFBSSxHQUFHLE1BQU0sSUFBSUMsbUJBQUosR0FBYUMsWUFBYixDQUNoQixHQUFFUCxpQkFBa0IsSUFBR1EsZ0JBQUtDLE1BQUwsR0FBY0MsUUFBZCxHQUF5QkMsV0FBekIsRUFBdUMsSUFBR1QsSUFBSSxDQUFDVSxVQUFXLEVBRGpFLEVBRWpCVixJQUFJLENBQUNVLFVBRlksRUFHakJWLElBQUksQ0FBQ1csZUFIWSxFQUlqQjtBQUFDVixJQUFBQTtBQUFELEdBSmlCLENBQW5CO0FBTUEsU0FBTyxNQUFNLHNDQUFhRSxJQUFiLEVBQW1CO0FBQzlCRixJQUFBQSxRQUQ4QjtBQUU5QlcsSUFBQUEsY0FBYyxFQUFFO0FBRmMsR0FBbkIsQ0FBYjtBQUlEOztBQVVELGVBQWVDLGNBQWYsQ0FBK0JDLElBQS9CLEVBQXFDO0FBQ25DLE1BQUlDLGdCQUFKOztBQUVBLE9BQUssTUFBTUMsTUFBWCxJQUFxQkMsZ0JBQUVDLE1BQUYsRUFBUyxNQUFNLElBQUlkLG1CQUFKLEdBQWFlLFVBQWIsQ0FBd0JMLElBQUksQ0FBQ0gsZUFBN0IsQ0FBZixFQUFyQixFQUFvRjtBQUNsRixRQUFJSyxNQUFNLENBQUNJLElBQVAsS0FBZ0JOLElBQUksQ0FBQ0osVUFBekIsRUFBcUM7QUFDbkMsYUFBTyxNQUFNLHNDQUFhTSxNQUFNLENBQUNiLElBQXBCLEVBQTBCO0FBQ3JDRixRQUFBQSxRQUFRLEVBQUVlLE1BQU0sQ0FBQ2YsUUFEb0I7QUFFckNXLFFB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QWlCQyxvQkFBS0MsU0FBTCxDQUFlLFdBQWYsRUFBNEJMLGtCQUFrQixDQUFDRyxNQUEvQyxDQUF1RCxHQUE5RyxHQUNOLHVCQURIOztBQUVBLE9BQUssTUFBTTtBQUFDOUQsSUFBQUE7QUFBRCxHQUFYLElBQXFCMkQsa0JBQXJCLEVBQXlDO0FBR3ZDLFVBQU0sOENBQW1CM0QsSUFBbkIsRUFBeUIsSUFBekIsQ0FBTjtBQUNBdUMsSUFBQUEsTUFBTSxDQUFDdkMsSUFBUCxHQUFjQSxJQUFkO0FBQ0EsVUFBTXVDLE1BQU0sQ0FBQzBCLGNBQVAsRUFBTjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRTaW11bGF0b3IgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgU2ltY3RsIGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IHJlc2V0VGVzdFByb2Nlc3NlcyB9IGZyb20gJ2FwcGl1bS13ZWJkcml2ZXJhZ2VudCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBQTEFURk9STV9OQU1FX0lPUyB9IGZyb20gJy4vZGVzaXJlZC1jYXBzJztcblxuXG5jb25zdCBBUFBJVU1fU0lNX1BSRUZJWCA9ICdhcHBpdW1UZXN0JztcblxuLyoqXG4gKiBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXJcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2aWNlTmFtZSAtIEEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqL1xuLyoqXG4gKiBDcmVhdGUgYSBuZXcgc2ltdWxhdG9yIHdpdGggYGFwcGl1bVRlc3QtYCBwcmVmaXggYW5kIHJldHVybiB0aGUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBTaW1DcmVhdGlvbkNhcHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm0gW2lPU10gLSBQbGF0Zm9ybSBuYW1lIGluIG9yZGVyIHRvIHNwZWNpZnkgcnVudGltZSBzdWNoIGFzICdpT1MnLCAndHZPUycsICd3YXRjaE9TJ1xuICogQHJldHVybnMge29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHBsYXRmb3JtID0gUExBVEZPUk1fTkFNRV9JT1MpIHtcbiAgY29uc3QgdWRpZCA9IGF3YWl0IG5ldyBTaW1jdGwoKS5jcmVhdGVEZXZpY2UoXG4gICAgYCR7QVBQSVVNX1NJTV9QUkVGSVh9LSR7VVVJRC5jcmVhdGUoKS50b1N0cmluZygpLnRvVXBwZXJDYXNlKCl9LSR7Y2Fwcy5kZXZpY2VOYW1lfWAsXG4gICAgY2Fwcy5kZXZpY2VOYW1lLFxuICAgIGNhcHMucGxhdGZvcm1WZXJzaW9uLFxuICAgIHtwbGF0Zm9ybX0sXG4gICk7XG4gIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCwge1xuICAgIHBsYXRmb3JtLFxuICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgfSk7XG59XG5cbi8qKlxuICogR2V0IGEgc2ltdWxhdG9yIHdoaWNoIGlzIGFscmVhZHkgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gb3B0cyAtIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlci4gVGhlIG9wdGlvbnMgYXZhaWxhYmxlIGFyZTpcbiAqICAgLSBgZGV2aWNlTmFtZWAgLSBhIG5hbWUgZm9yIHRoZSBkZXZpY2VcbiAqICAgLSBgcGxhdGZvcm1WZXJzaW9uYCAtIHRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqIEByZXR1cm5zIHs/b2JqZWN0fSBTaW11bGF0b3Igb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGUgdWRpZCBwYXNzZWQgaW4uIE9yIG51bGwgaWYgbm8gZGV2aWNlIGlzIHJ1bm5pbmcuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEV4aXN0aW5nU2ltIChvcHRzKSB7XG4gIGxldCBhcHBpdW1UZXN0RGV2aWNlO1xuXG4gIGZvciAoY29uc3QgZGV2aWNlIG9mIF8udmFsdWVzKGF3YWl0IG5ldyBTaW1jdGwoKS5nZXREZXZpY2VzKG9wdHMucGxhdGZvcm1WZXJzaW9uKSkpIHtcbiAgICBpZiAoZGV2aWNlLm5hbWUgPT09IG9wdHMuZGV2aWNlTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcihkZXZpY2UudWRpZCwge1xuICAgICAgICBwbGF0Zm9ybTogZGV2aWNlLnBsYXRmb3JtLFxuICAgICAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZGV2aWNlLm5hbWUuc3RhcnRzV2l0aChBUFBJVU1fU0lNX1BSRUZJWCkgJiYgZGV2aWNlLm5hbWUuZW5kc1dpdGgob3B0cy5kZXZpY2VOYW1lKSkge1xuICAgICAgYXBwaXVtVGVzdERldmljZSA9IGRldmljZTtcbiAgICAgIC8vIGNob29zZSB0aGUgZmlyc3QgYm9vdGVkIHNpbXVsYXRvclxuICAgICAgaWYgKGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKGFwcGl1bVRlc3REZXZpY2UpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlICcke29wdHMuZGV2aWNlTmFtZX0nLiBGb3VuZCAnJHthcHBpdW1UZXN0RGV2aWNlLm5hbWV9JyAodWRpZDogJyR7YXBwaXVtVGVzdERldmljZS51ZGlkfScpIGluc3RlYWRgKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKGFwcGl1bVRlc3REZXZpY2UudWRpZCwge1xuICAgICAgcGxhdGZvcm06IGFwcGl1bVRlc3REZXZpY2UucGxhdGZvcm0sXG4gICAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duU2ltdWxhdG9yIChkZXZpY2UpIHtcbiAgLy8gc3RvcCBYQ1Rlc3QgcHJvY2Vzc2VzIGlmIHJ1bm5pbmcgdG8gYXZvaWQgdW5leHBlY3RlZCBzaWRlIGVmZmVjdHNcbiAgYXdhaXQgcmVzZXRUZXN0UHJvY2Vzc2VzKGRldmljZS51ZGlkLCB0cnVlKTtcbiAgYXdhaXQgZGV2aWNlLnNodXRkb3duKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blNpbXVsYXRvclJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKG9wdHMubm9SZXNldCAmJiAhb3B0cy5mdWxsUmVzZXQpIHtcbiAgICAvLyBub1Jlc2V0ID09PSB0cnVlICYmIGZ1bGxSZXNldCA9PT0gZmFsc2VcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBub1Jlc2V0IGlzIG9uLiBMZWF2aW5nIHNpbXVsYXRvciBhcyBpcycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghZGV2aWNlKSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm8gZGV2aWNlIGF2YWlsYWJsZS4gU2tpcHBpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAob3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBmdWxsUmVzZXQgaXMgb24uIENsZWFuaW5nIHNpbXVsYXRvcicpO1xuICAgIGF3YWl0IHNodXRkb3duU2ltdWxhdG9yKGRldmljZSk7XG4gICAgbGV0IGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIGlmIChvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBvcHRzLmtlZXBLZXlDaGFpbnMpIHtcbiAgICAgIGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGF3YWl0IGRldmljZS5iYWNrdXBLZXljaGFpbnMoKTtcbiAgICB9XG4gICAgYXdhaXQgZGV2aWNlLmNsZWFuKCk7XG4gICAgaWYgKGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZGV2aWNlLnJlc3RvcmVLZXljaGFpbnMob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgW10pO1xuICAgICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSByZXN0b3JlZCBrZXljaGFpbnMgYWZ0ZXIgZnVsbCByZXNldGApO1xuICAgIH0gZWxzZSBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBsb2cud2FybignQ2Fubm90IHJlc3RvcmUga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXQsIGJlY2F1c2UgJyArXG4gICAgICAgICAgICAgICAndGhlIGJhY2t1cCBvcGVyYXRpb24gZGlkIG5vdCBzdWNjZWVkJyk7XG4gICAgfVxuICB9IGVsc2UgaWYgKG9wdHMuYnVuZGxlSWQpIHtcbiAgICAvLyBmYXN0UmVzZXQgb3Igbm9SZXNldFxuXG4gICAgLy8gVGVybWluYXRlIHRoZSBhcHAgdW5kZXIgdGVzdCBpZiBpdCBpcyBzdGlsbCBydW5uaW5nIG9uIFNpbXVsYXRvclxuICAgIC8vIFRlcm1pbmF0aW9uIGlzIG5vdCBuZWVkZWQgaWYgU2ltdWxhdG9yIGlzIG5vdCBydW5uaW5nXG4gICAgaWYgKGF3YWl0IGRldmljZS5pc1J1bm5pbmcoKSkge1xuICAgICAgaWYgKG9wdHMuZW5mb3JjZVNpbXVsYXRvclNodXRkb3duKSB7XG4gICAgICAgIGF3YWl0IHNodXRkb3duU2ltdWxhdG9yKGRldmljZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGRldmljZS5zaW1jdGwudGVybWluYXRlQXBwKG9wdHMuYnVuZGxlSWQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cud2FybihgUmVzZXQ6IGZhaWxlZCB0byB0ZXJtaW5hdGUgU2ltdWxhdG9yIGFwcGxpY2F0aW9uIHdpdGggaWQgXCIke29wdHMuYnVuZGxlSWR9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3B0cy5hcHApIHtcbiAgICAgIGxvZy5pbmZvKCdOb3Qgc2NydWJiaW5nIHRoaXJkIHBhcnR5IGFwcCBpbiBhbnRpY2lwYXRpb24gb2YgdW5pbnN0YWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGlzU2FmYXJpID0gKG9wdHMuYnJvd3Nlck5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdzYWZhcmknO1xuICAgIHRyeSB7XG4gICAgICBpZiAoaXNTYWZhcmkpIHtcbiAgICAgICAgYXdhaXQgZGV2aWNlLmNsZWFuU2FmYXJpKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpT1MgOCsgZG9lcyBub3QgbmVlZCBiYXNlbmFtZVxuICAgICAgICBhd2FpdCBkZXZpY2Uuc2NydWJDdXN0b21BcHAoJycsIG9wdHMuYnVuZGxlSWQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oZXJyLm1lc3NhZ2UpO1xuICAgICAgbG9nLndhcm4oYFJlc2V0OiBjb3VsZCBub3Qgc2NydWIgJHtpc1NhZmFyaSA/ICdTYWZhcmkgYnJvd3NlcicgOiAnYXBwbGljYXRpb24gd2l0aCBpZCBcIicgKyBvcHRzLmJ1bmRsZUlkICsgJ1wiJ30uIExlYXZpbmcgYXMgaXMuYCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW5zdGFsbE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBub1Jlc2V0IFtmYWxzZV0gV2hldGhlciB0byBkaXNhYmxlIHJlc2V0XG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBuZXdTaW11bGF0b3IgW2ZhbHNlXSBXaGV0aGVyIHRoZSBzaW11bGF0b3IgaXMgYnJhbmQgbmV3XG4gKi9cblxuLyoqXG4gKiBAcGFyYW0ge29iamVjdH0gZGV2aWNlIFRoZSBzaW11bGF0b3IgZGV2aWNlIG9iamVjdFxuICogQHBhcmFtIHs/c3RyaW5nfSBhcHAgVGhlIGFwcCB0byB0aGUgcGF0aFxuICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIFRoZSBidW5kbGUgaWQgdG8gZW5zdXJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgaXQgaXMgYWxyZWFkeSBpbnN0YWxsZWQgYW5kIHVuaW5zdGFsbCBpdFxuICogQHBhcmFtIHs/SW5zdGFsbE9wdGlvbnN9IG9wdHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFRvU2ltdWxhdG9yIChkZXZpY2UsIGFwcCwgYnVuZGxlSWQsIG9wdHMgPSB7fSkge1xuICBpZiAoIWFwcCkge1xuICAgIGxvZy5kZWJ1ZygnTm8gYXBwIHBhdGggaXMgZ2l2ZW4uIE5vdGhpbmcgdG8gaW5zdGFsbC4nKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7XG4gICAgbm9SZXNldCA9IHRydWUsXG4gICAgbmV3U2ltdWxhdG9yID0gZmFsc2UsXG4gIH0gPSBvcHRzO1xuXG4gIGlmICghbmV3U2ltdWxhdG9yICYmIGJ1bmRsZUlkICYmIGF3YWl0IGRldmljZS5pc0FwcEluc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICBpZiAobm9SZXNldCkge1xuICAgICAgbG9nLmRlYnVnKGBBcHAgJyR7YnVuZGxlSWR9JyBpcyBhbHJlYWR5IGluc3RhbGxlZC4gTm8gbmVlZCB0byByZWluc3RhbGwuYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUmVzZXQgcmVxdWVzdGVkLiBSZW1vdmluZyBhcHAgd2l0aCBpZCAnJHtidW5kbGVJZH0nIGZyb20gdGhlIGRldmljZWApO1xuICAgIGF3YWl0IGRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nICcke2FwcH0nIG9uIFNpbXVsYXRvciB3aXRoIFVVSUQgJyR7ZGV2aWNlLnVkaWR9Jy4uLmApO1xuICB0cnkge1xuICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBpdCBzb21ldGltZXMgZmFpbHMgb24gWGNvZGUgMTAgYmVjYXVzZSBvZiBhIHJhY2UgY29uZGl0aW9uXG4gICAgbG9nLmluZm8oYEdvdCBhbiBlcnJvciBvbiAnJHthcHB9JyBpbnN0YWxsOiAke2UubWVzc2FnZX1gKTtcbiAgICBsb2cuaW5mbygnUmV0cnlpbmcgYXBwbGljYXRpb24gaW5zdGFsbCcpO1xuICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdUaGUgYXBwIGhhcyBiZWVuIGluc3RhbGxlZCBzdWNjZXNzZnVsbHkuJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duT3RoZXJTaW11bGF0b3JzIChjdXJyZW50RGV2aWNlKSB7XG4gIGNvbnN0IHNpbWN0bCA9IG5ldyBTaW1jdGwoKTtcbiAgY29uc3QgYWxsRGV2aWNlcyA9IF8uZmxhdE1hcChfLnZhbHVlcyhhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcygpKSk7XG4gIGNvbnN0IG90aGVyQm9vdGVkRGV2aWNlcyA9IGFsbERldmljZXMuZmlsdGVyKChkZXZpY2UpID0+IGRldmljZS51ZGlkICE9PSBjdXJyZW50RGV2aWNlLnVkaWQgJiYgZGV2aWNlLnN0YXRlID09PSAnQm9vdGVkJyk7XG4gIGlmIChfLmlzRW1wdHkob3RoZXJCb290ZWREZXZpY2VzKSkge1xuICAgIGxvZy5pbmZvKCdObyBvdGhlciBydW5uaW5nIHNpbXVsYXRvcnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy5pbmZvKGBEZXRlY3RlZCAke290aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGh9IG90aGVyIHJ1bm5pbmcgJHt1dGlsLnBsdXJhbGl6ZSgnU2ltdWxhdG9yJywgb3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aCl9LmAgK1xuICAgIGBTaHV0dGluZyB0aGVtIGRvd24uLi5gKTtcbiAgZm9yIChjb25zdCB7dWRpZH0gb2Ygb3RoZXJCb290ZWREZXZpY2VzKSB7XG4gICAgLy8gSXQgaXMgbmVjZXNzYXJ5IHRvIHN0b3AgdGhlIGNvcnJlc3BvbmRpbmcgeGNvZGVidWlsZCBwcm9jZXNzIGJlZm9yZSBraWxsaW5nXG4gICAgLy8gdGhlIHNpbXVsYXRvciwgb3RoZXJ3aXNlIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSByZXN0YXJ0ZWRcbiAgICBhd2FpdCByZXNldFRlc3RQcm9jZXNzZXModWRpZCwgdHJ1ZSk7XG4gICAgc2ltY3RsLnVkaWQgPSB1ZGlkO1xuICAgIGF3YWl0IHNpbWN0bC5zaHV0ZG93bkRldmljZSgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0LCBpbnN0YWxsVG9TaW11bGF0b3IsXG4gIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyB9O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
