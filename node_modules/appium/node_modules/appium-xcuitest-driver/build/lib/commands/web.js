"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const IPHONE_TOP_BAR_HEIGHT = 71;
const IPHONE_SCROLLED_TOP_BAR_HEIGHT = 41;
const IPHONE_X_NOTCH_OFFSET_IOS = 24;
const IPHONE_X_NOTCH_OFFSET_IOS_13 = 20;
const IPHONE_LANDSCAPE_TOP_BAR_HEIGHT = 51;
const IPHONE_BOTTOM_BAR_OFFSET = 49;
const TAB_BAR_OFFSET = 33;
const IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
const IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;
const IPHONE_X_WIDTH = 375;
const IPHONE_X_HEIGHT = 812;
const IPHONE_XR_WIDTH = 414;
const IPHONE_XR_HEIGHT = 896;
const ATOM_WAIT_TIMEOUT = 5 * 60000;
let extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.web);
extensions.getSafariIsIphone = _lodash.default.memoize(async function getSafariIsIphone() {
  try {
    const userAgent = await this.execute('return navigator.userAgent');
    return userAgent.toLowerCase().includes('iphone');
  } catch (err) {
    _logger.default.warn(`Unable to find device type from useragent. Assuming iPhone`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return true;
});
extensions.getSafariIsIphoneX = _lodash.default.memoize(async function getSafariIsIphone() {
  try {
    const script = 'return {height: window.screen.availHeight, width: window.screen.availWidth};';
    const {
      height,
      width
    } = await this.execute(script);
    const [portraitHeight, portraitWidth] = height > width ? [height, width] : [width, height];
    return portraitHeight === IPHONE_X_HEIGHT && portraitWidth === IPHONE_X_WIDTH || portraitHeight === IPHONE_XR_HEIGHT && portraitWidth === IPHONE_XR_WIDTH;
  } catch (err) {
    _logger.default.warn(`Unable to find device type from dimensions. Assuming not iPhone X`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return false;
});

extensions.getExtraTranslateWebCoordsOffset = async function getExtraTranslateWebCoordsOffset(wvPos, realDims) {
  let topOffset = 0;
  let bottomOffset = 0;
  const implicitWaitMs = this.implicitWaitMs;
  const isIphone = await this.getSafariIsIphone();
  const isIphoneX = isIphone && (await this.getSafariIsIphoneX());
  const orientation = realDims.h > realDims.w ? 'PORTRAIT' : 'LANDSCAPE';
  const notchOffset = isIphoneX ? _appiumSupport.util.compareVersions(this.opts.platformVersion, '=', '13.0') ? IPHONE_X_NOTCH_OFFSET_IOS_13 : IPHONE_X_NOTCH_OFFSET_IOS : 0;

  try {
    this.setImplicitWait(0);
    await this.findNativeElementOrElements('accessibility id', 'ReloadButton', false);
    topOffset = IPHONE_TOP_BAR_HEIGHT + notchOffset;

    if (isIphone) {
      if (orientation === 'PORTRAIT') {
        bottomOffset = IPHONE_BOTTOM_BAR_OFFSET;
      } else {
        topOffset = IPHONE_LANDSCAPE_TOP_BAR_HEIGHT;
      }
    }

    if (orientation === 'LANDSCAPE' || !isIphone) {
      try {
        await this.findNativeElementOrElements('-ios predicate string', `name LIKE '*, Tab' AND visible = 1`, false);
        topOffset += TAB_BAR_OFFSET;
      } catch (ign) {}
    }
  } catch (err) {
    topOffset = IPHONE_SCROLLED_TOP_BAR_HEIGHT + notchOffset;

    if (orientation === 'LANDSCAPE' && isIphone) {
      topOffset = 0;
    }
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  topOffset += await this.getExtraNativeWebTapOffset();
  wvPos.y += topOffset;
  realDims.h -= topOffset + bottomOffset;
};

extensions.getExtraNativeWebTapOffset = async function getExtraNativeWebTapOffset() {
  let offset = 0;
  const implicitWaitMs = this.implicitWaitMs;

  try {
    this.setImplicitWait(0);

    try {
      await this.findNativeElementOrElements('accessibility id', 'Close app download offer', false);
      offset += (await this.getSafariIsIphone()) ? IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET : IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;
    } catch (ign) {}
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  _logger.default.debug(`Additional native web tap offset computed: ${offset}`);

  return offset;
};

async function tapWebElementNatively(driver, atomsElement) {
  try {
    let text = await driver.executeAtom('get_text', [atomsElement]);

    if (!text) {
      text = await driver.executeAtom('get_attribute_value', [atomsElement, 'value']);
    }

    if (text) {
      const els = await driver.findNativeElementOrElements('accessibility id', text, true);

      if (els.length === 1 || els.length === 2) {
        const el = els[0];
        const rect = await driver.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(el)}/rect`, 'GET');

        if (els.length === 2) {
          const el2 = els[1];
          const rect2 = await driver.proxyCommand(`/element/${_appiumSupport.util.unwrapElement(el2)}/rect`, 'GET');

          if (rect.x !== rect2.x || rect.y !== rect2.y || rect.width !== rect2.width || rect.height !== rect2.height) {
            return false;
          }
        }

        const coords = {
          x: Math.round(rect.x + rect.width / 2),
          y: Math.round(rect.y + rect.height / 2)
        };
        await driver.clickCoords(coords);
        return true;
      }
    }
  } catch (err) {
    _logger.default.warn(`Error attempting to click: ${err.message}`);
  }

  return false;
}

extensions.nativeWebTap = async function nativeWebTap(el) {
  const atomsElement = this.useAtomsElement(el);

  if (await tapWebElementNatively(this, atomsElement)) {
    return;
  }

  _logger.default.warn('Unable to do simple native web tap. Attempting to convert coordinates');

  await this.executeAtom('get_size', [atomsElement]);
  await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  const {
    width,
    height
  } = await this.executeAtom('get_size', [atomsElement]);
  let {
    x,
    y
  } = await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  x += width / 2;
  y += height / 2;
  this.curWebCoords = {
    x,
    y
  };
  await this.clickWebCoords();
};

extensions.clickCoords = async function clickCoords(coords) {
  await this.performTouch([{
    action: 'tap',
    options: coords
  }]);
};

extensions.translateWebCoords = async function translateWebCoords(coords) {
  _logger.default.debug(`Translating coordinates (${JSON.stringify(coords)}) to web coordinates`);

  const implicitWaitMs = this.implicitWaitMs;
  let webview;

  try {
    this.setImplicitWait(0);
    webview = await (0, _asyncbox.retryInterval)(5, 100, async () => {
      return await this.findNativeElementOrElements('class name', 'XCUIElementTypeWebView', false);
    });
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  webview = _appiumSupport.util.unwrapElement(webview);
  const rect = await this.proxyCommand(`/element/${webview}/rect`, 'GET');
  const wvPos = {
    x: rect.x,
    y: rect.y
  };
  const realDims = {
    w: rect.width,
    h: rect.height
  };
  const cmd = '(function () { return {w: window.innerWidth, h: window.innerHeight}; })()';
  const wvDims = await this.remote.execute(cmd);
  await this.getExtraTranslateWebCoordsOffset(wvPos, realDims);

  if (wvDims && realDims && wvPos) {
    let xRatio = realDims.w / wvDims.w;
    let yRatio = realDims.h / wvDims.h;
    let newCoords = {
      x: wvPos.x + Math.round(xRatio * coords.x),
      y: wvPos.y + Math.round(yRatio * coords.y)
    };

    _logger.default.debug(`Converted coordinates: ${JSON.stringify(newCoords)}`);

    _logger.default.debug(`    rect: ${JSON.stringify(rect)}`);

    _logger.default.debug(`    wvPos: ${JSON.stringify(wvPos)}`);

    _logger.default.debug(`    realDims: ${JSON.stringify(realDims)}`);

    _logger.default.debug(`    wvDims: ${JSON.stringify(wvDims)}`);

    _logger.default.debug(`    xRatio: ${JSON.stringify(xRatio)}`);

    _logger.default.debug(`    yRatio: ${JSON.stringify(yRatio)}`);

    _logger.default.debug(`Converted web coords ${JSON.stringify(coords)} ` + `into real coords ${JSON.stringify(newCoords)}`);

    return newCoords;
  }
};

extensions.checkForAlert = async function checkForAlert() {
  try {
    await this.getAlert();
    return true;
  } catch (ign) {}

  return false;
};

extensions.waitForAtom = async function waitForAtom(promise) {
  const timer = new _appiumSupport.timing.Timer().start();
  let done = false;
  let error = null;

  _bluebird.default.resolve(promise).timeout(ATOM_WAIT_TIMEOUT).catch(function (err) {
    _logger.default.debug(`Error received while executing atom: ${err.message}`);

    error = err;
  }).finally(function () {
    done = true;
  });

  for (let i = 0; i < 10; i++) {
    if (done) break;
    await _bluebird.default.delay(500);
    if (done) break;

    if (await this.checkForAlert()) {
      return '';
    }
  }

  let res = await promise;

  if (error instanceof _bluebird.default.TimeoutError) {
    throw new Error(`Did not get any response for atom execution after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }

  return this.parseExecuteResponse(res);
};

extensions.mobileWebNav = async function mobileWebNav(navType) {
  this.remote.allowNavigationWithoutReload = true;

  try {
    await this.executeAtom('execute_script', [`history.${navType}();`, null]);
  } finally {
    this.remote.allowNavigationWithoutReload = false;
  }
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93ZWIuanMiXSwibmFtZXMiOlsiSVBIT05FX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1hfTk9UQ0hfT0ZGU0VUX0lPUyIsIklQSE9ORV9YX05PVENIX09GRlNFVF9JT1NfMTMiLCJJUEhPTkVfTEFORFNDQVBFX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX0JPVFRPTV9CQVJfT0ZGU0VUIiwiVEFCX0JBUl9PRkZTRVQiLCJJUEhPTkVfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUIiwiSVBBRF9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQiLCJJUEhPTkVfWF9XSURUSCIsIklQSE9ORV9YX0hFSUdIVCIsIklQSE9ORV9YUl9XSURUSCIsIklQSE9ORV9YUl9IRUlHSFQiLCJBVE9NX1dBSVRfVElNRU9VVCIsImV4dGVuc2lvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJpb3NDb21tYW5kcyIsIndlYiIsImdldFNhZmFyaUlzSXBob25lIiwiXyIsIm1lbW9pemUiLCJ1c2VyQWdlbnQiLCJleGVjdXRlIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImVyciIsImxvZyIsIndhcm4iLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJnZXRTYWZhcmlJc0lwaG9uZVgiLCJzY3JpcHQiLCJoZWlnaHQiLCJ3aWR0aCIsInBvcnRyYWl0SGVpZ2h0IiwicG9ydHJhaXRXaWR0aCIsImdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0Iiwid3ZQb3MiLCJyZWFsRGltcyIsInRvcE9mZnNldCIsImJvdHRvbU9mZnNldCIsImltcGxpY2l0V2FpdE1zIiwiaXNJcGhvbmUiLCJpc0lwaG9uZVgiLCJvcmllbnRhdGlvbiIsImgiLCJ3Iiwibm90Y2hPZmZzZXQiLCJ1dGlsIiwiY29tcGFyZVZlcnNpb25zIiwib3B0cyIsInBsYXRmb3JtVmVyc2lvbiIsInNldEltcGxpY2l0V2FpdCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImlnbiIsImdldEV4dHJhTmF0aXZlV2ViVGFwT2Zmc2V0IiwieSIsIm9mZnNldCIsInRhcFdlYkVsZW1lbnROYXRpdmVseSIsImRyaXZlciIsImF0b21zRWxlbWVudCIsInRleHQiLCJleGVjdXRlQXRvbSIsImVscyIsImxlbmd0aCIsImVsIiwicmVjdCIsInByb3h5Q29tbWFuZCIsInVud3JhcEVsZW1lbnQiLCJlbDIiLCJyZWN0MiIsIngiLCJjb29yZHMiLCJNYXRoIiwicm91bmQiLCJjbGlja0Nvb3JkcyIsIm5hdGl2ZVdlYlRhcCIsInVzZUF0b21zRWxlbWVudCIsImN1cldlYkNvb3JkcyIsImNsaWNrV2ViQ29vcmRzIiwicGVyZm9ybVRvdWNoIiwiYWN0aW9uIiwib3B0aW9ucyIsInRyYW5zbGF0ZVdlYkNvb3JkcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ3ZWJ2aWV3IiwiY21kIiwid3ZEaW1zIiwicmVtb3RlIiwieFJhdGlvIiwieVJhdGlvIiwibmV3Q29vcmRzIiwiY2hlY2tGb3JBbGVydCIsImdldEFsZXJ0Iiwid2FpdEZvckF0b20iLCJwcm9taXNlIiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiZG9uZSIsImVycm9yIiwiQiIsInJlc29sdmUiLCJ0aW1lb3V0IiwiY2F0Y2giLCJmaW5hbGx5IiwiaSIsImRlbGF5IiwicmVzIiwiVGltZW91dEVycm9yIiwiRXJyb3IiLCJnZXREdXJhdGlvbiIsImFzTWlsbGlTZWNvbmRzIiwidG9GaXhlZCIsInBhcnNlRXhlY3V0ZVJlc3BvbnNlIiwibW9iaWxlV2ViTmF2IiwibmF2VHlwZSIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEscUJBQXFCLEdBQUcsRUFBOUI7QUFDQSxNQUFNQyw4QkFBOEIsR0FBRyxFQUF2QztBQUNBLE1BQU1DLHlCQUF5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R0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUcsRUFBcEIsRUFBd0JBLENBQUMsRUFBekIsRUFBNkI7QUFFM0IsUUFBSVAsSUFBSixFQUFVO0FBQ1YsVUFBTUUsa0JBQUVNLEtBQUYsQ0FBUSxHQUFSLENBQU47QUFDQSxRQUFJUixJQUFKLEVBQVU7O0FBRVYsUUFBSSxNQUFNLEtBQUtSLGFBQUwsRUFBVixFQUFnQztBQUU5QixhQUFPLEVBQVA7QUFDRDtBQUNGOztBQUVELE1BQUlpQixHQUFHLEdBQUcsTUFBTWQsT0FBaEI7O0FBQ0EsTUFBSU0sS0FBSyxZQUFZQyxrQkFBRVEsWUFBdkIsRUFBcUM7QUFDbkMsVUFBTSxJQUFJQyxLQUFKLENBQVcscURBQW9EZixLQUFLLENBQUNnQixXQUFOLEdBQW9CQyxjQUFwQixDQUFtQ0MsT0FBbkMsQ0FBMkMsQ0FBM0MsQ0FBOEMsSUFBN0csQ0FBTjtBQUNEOztBQUNELFNBQU8sS0FBS0Msb0JBQUwsQ0FBMEJOLEdBQTFCLENBQVA7QUFDRCxDQXBDRDs7QUFzQ0FqRyxVQUFVLENBQUN3RyxZQUFYLEdBQTBCLGVBQWVBLFlBQWYsQ0FBNkJDLE9BQTdCLEVBQXNDO0FBQzlELE9BQUs3QixNQUFMLENBQVk4Qiw0QkFBWixHQUEyQyxJQUEzQzs7QUFDQSxNQUFJO0FBQ0YsVUFBTSxLQUFLekQsV0FBTCxDQUFpQixnQkFBakIsRUFBbUMsQ0FBRSxXQUFVd0QsT0FBUSxLQUFwQixFQUEwQixJQUExQixDQUFuQyxDQUFOO0FBQ0QsR0FGRCxTQUVVO0FBQ1IsU0FBSzdCLE1BQUwsQ0FBWThCLDRCQUFaLEdBQTJDLEtBQTNDO0FBQ0Q7QUFDRixDQVBEOztlQVVlMUcsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHV0aWwsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IElQSE9ORV9UT1BfQkFSX0hFSUdIVCA9IDcxO1xuY29uc3QgSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUID0gNDE7XG5jb25zdCBJUEhPTkVfWF9OT1RDSF9PRkZTRVRfSU9TID0gMjQ7XG5jb25zdCBJUEhPTkVfWF9OT1RDSF9PRkZTRVRfSU9TXzEzID0gMjA7XG5jb25zdCBJUEhPTkVfTEFORFNDQVBFX1RPUF9CQVJfSEVJR0hUID0gNTE7XG5jb25zdCBJUEhPTkVfQk9UVE9NX0JBUl9PRkZTRVQgPSA0OTtcbmNvbnN0IFRBQl9CQVJfT0ZGU0VUID0gMzM7XG5jb25zdCBJUEhPTkVfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUID0gODQ7XG5jb25zdCBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDk1O1xuXG5jb25zdCBJUEhPTkVfWF9XSURUSCA9IDM3NTtcbmNvbnN0IElQSE9ORV9YX0hFSUdIVCA9IDgxMjtcbmNvbnN0IElQSE9ORV9YUl9XSURUSCA9IDQxNDtcbmNvbnN0IElQSE9ORV9YUl9IRUlHSFQgPSA4OTY7XG5cbmNvbnN0IEFUT01fV0FJVF9USU1FT1VUID0gNSAqIDYwMDAwO1xuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLndlYik7XG5cblxuXG5leHRlbnNpb25zLmdldFNhZmFyaUlzSXBob25lID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldFNhZmFyaUlzSXBob25lICgpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VyQWdlbnQgPSBhd2FpdCB0aGlzLmV4ZWN1dGUoJ3JldHVybiBuYXZpZ2F0b3IudXNlckFnZW50Jyk7XG4gICAgcmV0dXJuIHVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdpcGhvbmUnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSB0eXBlIGZyb20gdXNlcmFnZW50LiBBc3N1bWluZyBpUGhvbmVgKTtcbiAgICBsb2cuZGVidWcoYEVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiB0cnVlO1xufSk7XG5cbmV4dGVuc2lvbnMuZ2V0U2FmYXJpSXNJcGhvbmVYID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldFNhZmFyaUlzSXBob25lICgpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzY3JpcHQgPSAncmV0dXJuIHtoZWlnaHQ6IHdpbmRvdy5zY3JlZW4uYXZhaWxIZWlnaHQsIHdpZHRoOiB3aW5kb3cuc2NyZWVuLmF2YWlsV2lkdGh9Oyc7XG4gICAgY29uc3Qge2hlaWdodCwgd2lkdGh9ID0gYXdhaXQgdGhpcy5leGVjdXRlKHNjcmlwdCk7XG4gICAgLy8gY2hlY2sgZm9yIHRoZSBjb3JyZWN0IGhlaWdodCBhbmQgd2lkdGhcbiAgICBjb25zdCBbcG9ydHJhaXRIZWlnaHQsIHBvcnRyYWl0V2lkdGhdID0gaGVpZ2h0ID4gd2lkdGggPyBbaGVpZ2h0LCB3aWR0aF0gOiBbd2lkdGgsIGhlaWdodF07XG4gICAgcmV0dXJuIChwb3J0cmFpdEhlaWdodCA9PT0gSVBIT05FX1hfSEVJR0hUICYmIHBvcnRyYWl0V2lkdGggPT09IElQSE9ORV9YX1dJRFRIKSB8fFxuICAgICAgICAgICAocG9ydHJhaXRIZWlnaHQgPT09IElQSE9ORV9YUl9IRUlHSFQgJiYgcG9ydHJhaXRXaWR0aCA9PT0gSVBIT05FX1hSX1dJRFRIKTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlIHR5cGUgZnJvbSBkaW1lbnNpb25zLiBBc3N1bWluZyBub3QgaVBob25lIFhgKTtcbiAgICBsb2cuZGVidWcoYEVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn0pO1xuXG5leHRlbnNpb25zLmdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0RXh0cmFUcmFuc2xhdGVXZWJDb29yZHNPZmZzZXQgKHd2UG9zLCByZWFsRGltcykge1xuICBsZXQgdG9wT2Zmc2V0ID0gMDtcbiAgbGV0IGJvdHRvbU9mZnNldCA9IDA7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiBpbXBsaWNpdCB3YWl0LCBhbmQgc2V0IGxvY2FsbHkgdG8gMFxuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG5cbiAgY29uc3QgaXNJcGhvbmUgPSBhd2FpdCB0aGlzLmdldFNhZmFyaUlzSXBob25lKCk7XG4gIGNvbnN0IGlzSXBob25lWCA9IGlzSXBob25lICYmIGF3YWl0IHRoaXMuZ2V0U2FmYXJpSXNJcGhvbmVYKCk7XG5cbiAgY29uc3Qgb3JpZW50YXRpb24gPSByZWFsRGltcy5oID4gcmVhbERpbXMudyA/ICdQT1JUUkFJVCcgOiAnTEFORFNDQVBFJztcblxuICBjb25zdCBub3RjaE9mZnNldCA9IGlzSXBob25lWFxuICAgID8gdXRpbC5jb21wYXJlVmVyc2lvbnModGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiwgJz0nLCAnMTMuMCcpXG4gICAgICA/IElQSE9ORV9YX05PVENIX09GRlNFVF9JT1NfMTNcbiAgICAgIDogSVBIT05FX1hfTk9UQ0hfT0ZGU0VUX0lPU1xuICAgIDogMDtcblxuICB0cnkge1xuICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuXG4gICAgLy8gY2hlY2sgaWYgdGhlIGZ1bGwgdXJsIGJhciBpcyB1cFxuICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1JlbG9hZEJ1dHRvbicsIGZhbHNlKTtcblxuICAgIC8vIHJlbG9hZCBidXR0b24gZm91bmQsIHdoaWNoIG1lYW5zIHNjcm9sbGluZyBoYXMgbm90IGhhcHBlbmVkXG4gICAgdG9wT2Zmc2V0ID0gSVBIT05FX1RPUF9CQVJfSEVJR0hUICsgbm90Y2hPZmZzZXQ7XG4gICAgaWYgKGlzSXBob25lKSB7XG4gICAgICBpZiAob3JpZW50YXRpb24gPT09ICdQT1JUUkFJVCcpIHtcbiAgICAgICAgLy8gVGhlIGJvdHRvbSBiYXIgaXMgb25seSB2aXNpYmxlIHdoZW4gcG9ydHJhaXRcbiAgICAgICAgYm90dG9tT2Zmc2V0ID0gSVBIT05FX0JPVFRPTV9CQVJfT0ZGU0VUO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdG9wT2Zmc2V0ID0gSVBIT05FX0xBTkRTQ0FQRV9UT1BfQkFSX0hFSUdIVDtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9yaWVudGF0aW9uID09PSAnTEFORFNDQVBFJyB8fCAhaXNJcGhvbmUpIHtcbiAgICAgIC8vIFRhYnMgb25seSBhcHBlYXIgaWYgdGhlIGRldmljZSBpcyBsYW5kc2NhcGUgb3IgaWYgaXQncyBhbiBpUGFkIHNvIHdlIG9ubHkgY2hlY2sgdmlzaWJpbGl0eSBpbiB0aGlzIGNhc2VcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCctaW9zIHByZWRpY2F0ZSBzdHJpbmcnLCBgbmFtZSBMSUtFICcqLCBUYWInIEFORCB2aXNpYmxlID0gMWAsIGZhbHNlKTtcbiAgICAgICAgdG9wT2Zmc2V0ICs9IFRBQl9CQVJfT0ZGU0VUO1xuICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgIC8vIG5vIGVsZW1lbnQgZm91bmQsIHNvIG5vIHRhYnMgYW5kIG5vIG5lZWQgdG8gZGVhbCB3aXRoIG9mZnNldFxuICAgICAgfVxuICAgIH1cblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBubyByZWxvYWQgYnV0dG9uLCB3aGljaCBpbmRpY2F0ZXMgc2Nyb2xsaW5nIGhhcyBoYXBwZW5lZFxuICAgIHRvcE9mZnNldCA9IElQSE9ORV9TQ1JPTExFRF9UT1BfQkFSX0hFSUdIVCArIG5vdGNoT2Zmc2V0O1xuXG4gICAgLy8gSWYgdGhlIGlQaG9uZSBpcyBsYW5kc2NhcGUgdGhlbiB0aGVyZSBpcyBub3QgdG9wIGJhclxuICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ0xBTkRTQ0FQRScgJiYgaXNJcGhvbmUpIHtcbiAgICAgIHRvcE9mZnNldCA9IDA7XG4gICAgfVxuXG4gIH0gZmluYWxseSB7XG4gICAgLy8gcmV0dXJuIGltcGxpY2l0IHdhaXQgdG8gd2hhdCBpdCB3YXNcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICB0b3BPZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCgpO1xuXG4gIHd2UG9zLnkgKz0gdG9wT2Zmc2V0O1xuICByZWFsRGltcy5oIC09ICh0b3BPZmZzZXQgKyBib3R0b21PZmZzZXQpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCA9IGFzeW5jIGZ1bmN0aW9uIGdldEV4dHJhTmF0aXZlV2ViVGFwT2Zmc2V0ICgpIHtcbiAgbGV0IG9mZnNldCA9IDA7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiBpbXBsaWNpdCB3YWl0LCBhbmQgc2V0IGxvY2FsbHkgdG8gMFxuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG5cbiAgICAvLyB0cnkgdG8gc2VlIGlmIHRoZXJlIGlzIGFuIFNtYXJ0IEFwcCBCYW5uZXJcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnQ2xvc2UgYXBwIGRvd25sb2FkIG9mZmVyJywgZmFsc2UpO1xuICAgICAgb2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0U2FmYXJpSXNJcGhvbmUoKSA/XG4gICAgICAgIElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgOlxuICAgICAgICBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVDtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIHNtYXJ0IGFwcCBiYW5uZXIgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBBZGRpdGlvbmFsIG5hdGl2ZSB3ZWIgdGFwIG9mZnNldCBjb21wdXRlZDogJHtvZmZzZXR9YCk7XG4gIHJldHVybiBvZmZzZXQ7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB0YXBXZWJFbGVtZW50TmF0aXZlbHkgKGRyaXZlciwgYXRvbXNFbGVtZW50KSB7XG4gIC8vIHRyeSB0byBnZXQgdGhlIHRleHQgb2YgdGhlIGVsZW1lbnQsIHdoaWNoIHdpbGwgYmUgYWNjZXNzaWJsZSBpbiB0aGVcbiAgLy8gbmF0aXZlIGNvbnRleHRcbiAgdHJ5IHtcbiAgICBsZXQgdGV4dCA9IGF3YWl0IGRyaXZlci5leGVjdXRlQXRvbSgnZ2V0X3RleHQnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVBdG9tKCdnZXRfYXR0cmlidXRlX3ZhbHVlJywgW2F0b21zRWxlbWVudCwgJ3ZhbHVlJ10pO1xuICAgIH1cblxuICAgIGlmICh0ZXh0KSB7XG4gICAgICBjb25zdCBlbHMgPSBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgdGV4dCwgdHJ1ZSk7XG4gICAgICBpZiAoZWxzLmxlbmd0aCA9PT0gMSB8fCBlbHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIGNvbnN0IGVsID0gZWxzWzBdO1xuICAgICAgICAvLyB1c2UgdGFwIGJlY2F1c2Ugb24gaU9TIDExLjIgYW5kIGJlbG93IGBuYXRpdmVDbGlja2AgY3Jhc2hlcyBXREFcbiAgICAgICAgY29uc3QgcmVjdCA9IGF3YWl0IGRyaXZlci5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dXRpbC51bndyYXBFbGVtZW50KGVsKX0vcmVjdGAsICdHRVQnKTtcbiAgICAgICAgaWYgKGVscy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBjb25zdCBlbDIgPSBlbHNbMV07XG4gICAgICAgICAgY29uc3QgcmVjdDIgPSBhd2FpdCBkcml2ZXIucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3V0aWwudW53cmFwRWxlbWVudChlbDIpfS9yZWN0YCwgJ0dFVCcpO1xuXG4gICAgICAgICAgaWYgKChyZWN0LnggIT09IHJlY3QyLnggfHwgcmVjdC55ICE9PSByZWN0Mi55KSB8fFxuICAgICAgICAgIChyZWN0LndpZHRoICE9PSByZWN0Mi53aWR0aCB8fCByZWN0LmhlaWdodCAhPT0gcmVjdDIuaGVpZ2h0KSkge1xuICAgICAgICAgICAgLy8gVGhlc2UgMiBuYXRpdmUgZWxlbWVudHMgYXJlIG5vdCByZWZlcnJpbmcgdG8gdGhlIHNhbWUgd2ViIGVsZW1lbnRcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29vcmRzID0ge1xuICAgICAgICAgIHg6IE1hdGgucm91bmQocmVjdC54ICsgcmVjdC53aWR0aCAvIDIpLFxuICAgICAgICAgIHk6IE1hdGgucm91bmQocmVjdC55ICsgcmVjdC5oZWlnaHQgLyAyKSxcbiAgICAgICAgfTtcbiAgICAgICAgYXdhaXQgZHJpdmVyLmNsaWNrQ29vcmRzKGNvb3Jkcyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gYW55IGZhaWx1cmUgc2hvdWxkIGZhbGwgdGhyb3VnaCBhbmQgdHJpZ2dlciB0aGUgbW9yZSBlbGFib3JhdGVcbiAgICAvLyBtZXRob2Qgb2YgY2xpY2tpbmdcbiAgICBsb2cud2FybihgRXJyb3IgYXR0ZW1wdGluZyB0byBjbGljazogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmV4dGVuc2lvbnMubmF0aXZlV2ViVGFwID0gYXN5bmMgZnVuY3Rpb24gbmF0aXZlV2ViVGFwIChlbCkge1xuICBjb25zdCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG5cbiAgaWYgKGF3YWl0IHRhcFdlYkVsZW1lbnROYXRpdmVseSh0aGlzLCBhdG9tc0VsZW1lbnQpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy53YXJuKCdVbmFibGUgdG8gZG8gc2ltcGxlIG5hdGl2ZSB3ZWIgdGFwLiBBdHRlbXB0aW5nIHRvIGNvbnZlcnQgY29vcmRpbmF0ZXMnKTtcblxuICAvLyBgZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzYCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBzb21ldGltZXMsXG4gIC8vIHVubGVzcyB3ZSBwcmUtY2FsbCBib3RoIG9mIHRoZXNlIGZ1bmN0aW9ucyBiZWZvcmUgdGhlIGFjdHVhbCBjYWxsc1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfc2l6ZScsIFthdG9tc0VsZW1lbnRdKTtcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuXG4gIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICB4ICs9IHdpZHRoIC8gMjtcbiAgeSArPSBoZWlnaHQgLyAyO1xuXG4gIHRoaXMuY3VyV2ViQ29vcmRzID0ge3gsIHl9O1xuICBhd2FpdCB0aGlzLmNsaWNrV2ViQ29vcmRzKCk7XG59O1xuXG5leHRlbnNpb25zLmNsaWNrQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gY2xpY2tDb29yZHMgKGNvb3Jkcykge1xuICBhd2FpdCB0aGlzLnBlcmZvcm1Ub3VjaChbXG4gICAge1xuICAgICAgYWN0aW9uOiAndGFwJyxcbiAgICAgIG9wdGlvbnM6IGNvb3JkcyxcbiAgICB9LFxuICBdKTtcbn07XG5cbmV4dGVuc2lvbnMudHJhbnNsYXRlV2ViQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gdHJhbnNsYXRlV2ViQ29vcmRzIChjb29yZHMpIHtcbiAgbG9nLmRlYnVnKGBUcmFuc2xhdGluZyBjb29yZGluYXRlcyAoJHtKU09OLnN0cmluZ2lmeShjb29yZHMpfSkgdG8gd2ViIGNvb3JkaW5hdGVzYCk7XG5cbiAgLy8gYWJzb2x1dGl6ZSB3ZWIgY29vcmRzXG4gIGNvbnN0IGltcGxpY2l0V2FpdE1zID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgbGV0IHdlYnZpZXc7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG4gICAgd2VidmlldyA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwoNSwgMTAwLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlV2ViVmlldycsIGZhbHNlKTtcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICB3ZWJ2aWV3ID0gdXRpbC51bndyYXBFbGVtZW50KHdlYnZpZXcpO1xuICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7d2Vidmlld30vcmVjdGAsICdHRVQnKTtcbiAgY29uc3Qgd3ZQb3MgPSB7eDogcmVjdC54LCB5OiByZWN0Lnl9O1xuICBjb25zdCByZWFsRGltcyA9IHt3OiByZWN0LndpZHRoLCBoOiByZWN0LmhlaWdodH07XG5cbiAgY29uc3QgY21kID0gJyhmdW5jdGlvbiAoKSB7IHJldHVybiB7dzogd2luZG93LmlubmVyV2lkdGgsIGg6IHdpbmRvdy5pbm5lckhlaWdodH07IH0pKCknO1xuICBjb25zdCB3dkRpbXMgPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKGNtZCk7XG5cbiAgYXdhaXQgdGhpcy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCh3dlBvcywgcmVhbERpbXMpO1xuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyBNYXRoLnJvdW5kKHlSYXRpbyAqIGNvb3Jkcy55KSxcbiAgICB9O1xuXG4gICAgLy8gYWRkaXRpb25hbCBsb2dnaW5nIGZvciBjb29yZGluYXRlcywgc2luY2UgaXQgaXMgc29tZXRpbWVzIGJyb2tlblxuICAgIC8vICAgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy85MTU5XG4gICAgbG9nLmRlYnVnKGBDb252ZXJ0ZWQgY29vcmRpbmF0ZXM6ICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWN0OiAke0pTT04uc3RyaW5naWZ5KHJlY3QpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHd2UG9zOiAke0pTT04uc3RyaW5naWZ5KHd2UG9zKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWFsRGltczogJHtKU09OLnN0cmluZ2lmeShyZWFsRGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgd3ZEaW1zOiAke0pTT04uc3RyaW5naWZ5KHd2RGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeFJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHhSYXRpbyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeVJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHlSYXRpbyl9YCk7XG5cbiAgICBsb2cuZGVidWcoYENvbnZlcnRlZCB3ZWIgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0gYCArXG4gICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5leHRlbnNpb25zLmNoZWNrRm9yQWxlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0ZvckFsZXJ0ICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIC8vIG5vIGFsZXJ0IGZvdW5kLCBzbyBwYXNzIHRocm91Z2ggYW5kIHJldHVybiBmYWxzZVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmV4dGVuc2lvbnMud2FpdEZvckF0b20gPSBhc3luYyBmdW5jdGlvbiB3YWl0Rm9yQXRvbSAocHJvbWlzZSkge1xuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuXG4gIC8vIG5lZWQgdG8gY2hlY2sgZm9yIGFsZXJ0IHdoaWxlIHRoZSBhdG9tIGlzIGJlaW5nIGV4ZWN1dGVkLlxuICAvLyBzbyBub3RpZnkgb3Vyc2VsdmVzIHdoZW4gaXQgaGFwcGVuc1xuICBsZXQgZG9uZSA9IGZhbHNlO1xuICBsZXQgZXJyb3IgPSBudWxsO1xuICBCLnJlc29sdmUocHJvbWlzZSkgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL2NhdGNoLW9yLXJldHVyblxuICAgIC50aW1lb3V0KEFUT01fV0FJVF9USU1FT1VUKVxuICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICBsb2cuZGVidWcoYEVycm9yIHJlY2VpdmVkIHdoaWxlIGV4ZWN1dGluZyBhdG9tOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgLy8gZXJyb3IgZ2V0cyBzd2FsbG93ZWQsIHNvIHNhdmUgYW5kIGNoZWNrIGxhdGVyXG4gICAgICBlcnJvciA9IGVycjtcbiAgICB9KVxuICAgIC5maW5hbGx5KGZ1bmN0aW9uICgpIHtcbiAgICAgIGRvbmUgPSB0cnVlO1xuICAgIH0pO1xuXG4gIC8vIHRyeSB0ZW4gdGltZXMgdG8gY2hlY2sgYWxlcnQsIGlmIHdlIGFyZSBub3QgZG9uZSB5ZXRcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgLy8gY2hlY2sgaWYgdGhlIHByb21pc2UgaGFzIGJlZW4gcmVzb2x2ZWRcbiAgICBpZiAoZG9uZSkgYnJlYWs7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICBhd2FpdCBCLmRlbGF5KDUwMCk7XG4gICAgaWYgKGRvbmUpIGJyZWFrOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYW4gYWxlcnRcbiAgICBpZiAoYXdhaXQgdGhpcy5jaGVja0ZvckFsZXJ0KCkpIHtcbiAgICAgIC8vIHdlIGZvdW5kIGFuIGFsZXJ0LCBhbmQgc2hvdWxkIGp1c3QgcmV0dXJuIGNvbnRyb2xcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gIH1cblxuICBsZXQgcmVzID0gYXdhaXQgcHJvbWlzZTtcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3QgZ2V0IGFueSByZXNwb25zZSBmb3IgYXRvbSBleGVjdXRpb24gYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgfVxuICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShyZXMpO1xufTtcblxuZXh0ZW5zaW9ucy5tb2JpbGVXZWJOYXYgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVXZWJOYXYgKG5hdlR5cGUpIHtcbiAgdGhpcy5yZW1vdGUuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCA9IHRydWU7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbYGhpc3RvcnkuJHtuYXZUeXBlfSgpO2AsIG51bGxdKTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLnJlbW90ZS5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkID0gZmFsc2U7XG4gIH1cbn07XG5cblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3dlYi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
