"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
exports.convertResult = convertResult;
exports.RESPONSE_LOG_LENGTH = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _atoms = _interopRequireDefault(require("./atoms"));

var _lodash = _interopRequireDefault(require("lodash"));

var _assert = _interopRequireDefault(require("assert"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

const WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';
const SAFARI_WEB_VIEW_BUNDLE_ID = 'process-SafariViewService';
const SAFARI_WEB_VIEW_FULL_BUNDLE_ID = 'com.apple.SafariViewService';
const WILDCARD_BUNDLE_ID = '*';
const ACCEPTED_PAGE_TYPES = ['WIRTypeWeb', 'WIRTypeWebPage', 'WIRTypePage'];
const RESPONSE_LOG_LENGTH = 100;
exports.RESPONSE_LOG_LENGTH = RESPONSE_LOG_LENGTH;

function appInfoFromDict(dict) {
  const id = dict.WIRApplicationIdentifierKey;
  const isProxy = _lodash.default.isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  let isAutomationEnabled = !!dict.WIRRemoteAutomationEnabledKey;

  if (_lodash.default.has(dict, 'WIRAutomationAvailabilityKey')) {
    if (_lodash.default.isString(dict.WIRAutomationAvailabilityKey)) {
      isAutomationEnabled = dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityUnknown' ? 'Unknown' : dict.WIRAutomationAvailabilityKey === 'WIRAutomationAvailabilityAvailable';
    } else {
      isAutomationEnabled = !!dict.WIRAutomationAvailabilityKey;
    }
  }

  const entry = {
    id,
    isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled
  };
  return [id, entry];
}

function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    return [pageDict];
  }

  let newPageArray = [];

  for (const dict of _lodash.default.values(pageDict)) {
    if (_lodash.default.isUndefined(dict.WIRTypeKey) || ACCEPTED_PAGE_TYPES.includes(dict.WIRTypeKey)) {
      newPageArray.push({
        id: dict.WIRPageIdentifierKey,
        title: dict.WIRTitleKey,
        url: dict.WIRURLKey,
        isKey: !_lodash.default.isUndefined(dict.WIRConnectionIdentifierKey)
      });
    }
  }

  return newPageArray;
}

function getDebuggerAppKey(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId === bundleId) {
      appId = key;
      break;
    }
  }

  if (appId) {
    _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

    let proxyAppId;

    for (const [key, data] of _lodash.default.toPairs(appDict)) {
      if (data.isProxy && data.hostId === appId) {
        _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

        proxyAppId = key;
      }
    }

    if (proxyAppId) {
      appId = proxyAppId;

      _logger.default.debug(`Using proxied app id '${appId}'`);
    }
  }

  return appId;
}

function appIdForBundle(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId.endsWith(bundleId)) {
      appId = key;
      break;
    }
  }

  if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
    return appIdForBundle(WEB_CONTENT_BUNDLE_ID, appDict);
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleIds, appDict) {
  let proxiedAppIds = [];

  const possibleBundleIds = _lodash.default.uniq([SAFARI_WEB_VIEW_BUNDLE_ID, SAFARI_WEB_VIEW_FULL_BUNDLE_ID, WILDCARD_BUNDLE_ID, ...bundleIds]);

  _logger.default.debug(`Checking for bundle identifiers: ${possibleBundleIds.join(', ')}`);

  for (const bundleId of possibleBundleIds) {
    const appId = appIdForBundle(bundleId, appDict);

    if (appId) {
      proxiedAppIds.push(appId);

      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }
    }
  }

  return _lodash.default.uniq(proxiedAppIds);
}

function checkParams(params) {
  let errors = [];

  for (const [param, value] of _lodash.default.toPairs(params)) {
    try {
      _assert.default.ok(value);
    } catch (err) {
      errors.push(param);
    }
  }

  if (errors.length) {
    return errors;
  }
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  let elFromCache = await (0, _atoms.default)('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames, asyncCallBack = null) {
  let atomSrc = await (0, _atoms.default)(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true )`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

function simpleStringify(value, multiline = false) {
  if (!value) {
    return JSON.stringify(value);
  }

  let cleanValue = _lodash.default.clone(value);

  for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
    delete cleanValue[property];
  }

  return multiline ? JSON.stringify(cleanValue, null, 2) : JSON.stringify(cleanValue);
}

function deferredPromise() {
  let resolve;
  let reject;
  const promise = new _bluebird.default((res, rej) => {
    resolve = res;
    reject = rej;
  });
  return {
    promise,
    resolve,
    reject
  };
}

function convertResult(res) {
  if (_lodash.default.isUndefined(res)) {
    throw new Error(`Did not get OK result from remote debugger. Result was: ${_lodash.default.truncate(simpleStringify(res), {
      length: RESPONSE_LOG_LENGTH
    })}`);
  } else if (_lodash.default.isString(res)) {
    try {
      res = JSON.parse(res);
    } catch (err) {}
  } else if (!_lodash.default.isObject(res)) {
    throw new Error(`Result has unexpected type: (${typeof res}).`);
  }

  if (res.status && res.status !== 0) {
    throw (0, _appiumBaseDriver.errorFromMJSONWPStatusCode)(res.status, res.value.message || res.value);
  }

  let value = _lodash.default.has(res, 'value') ? res.value : res;

  if (_lodash.default.isObject(value)) {
    for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
      delete value[property];
    }
  }

  return value;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbIldFQl9DT05URU5UX0JVTkRMRV9JRCIsIlNBRkFSSV9XRUJfVklFV19CVU5ETEVfSUQiLCJTQUZBUklfV0VCX1ZJRVdfRlVMTF9CVU5ETEVfSUQiLCJXSUxEQ0FSRF9CVU5ETEVfSUQiLCJBQ0NFUFRFRF9QQUdFX1RZUEVTIiwiUkVTUE9OU0VfTE9HX0xFTkdUSCIsImFwcEluZm9Gcm9tRGljdCIsImRpY3QiLCJpZCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImlzUHJveHkiLCJfIiwiaXNTdHJpbmciLCJXSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkiLCJ0b0xvd2VyQ2FzZSIsImlzQXV0b21hdGlvbkVuYWJsZWQiLCJXSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSIsImhhcyIsIldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXkiLCJlbnRyeSIsIm5hbWUiLCJXSVJBcHBsaWNhdGlvbk5hbWVLZXkiLCJidW5kbGVJZCIsIldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSIsImhvc3RJZCIsIldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJpc0FjdGl2ZSIsIldJUklzQXBwbGljYXRpb25BY3RpdmVLZXkiLCJwYWdlQXJyYXlGcm9tRGljdCIsInBhZ2VEaWN0IiwibmV3UGFnZUFycmF5IiwidmFsdWVzIiwiaXNVbmRlZmluZWQiLCJXSVJUeXBlS2V5IiwiaW5jbHVkZXMiLCJwdXNoIiwiV0lSUGFnZUlkZW50aWZpZXJLZXkiLCJ0aXRsZSIsIldJUlRpdGxlS2V5IiwidXJsIiwiV0lSVVJMS2V5IiwiaXNLZXkiLCJXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSIsImdldERlYnVnZ2VyQXBwS2V5IiwiYXBwRGljdCIsImFwcElkIiwia2V5IiwiZGF0YSIsInRvUGFpcnMiLCJsb2ciLCJkZWJ1ZyIsInByb3h5QXBwSWQiLCJhcHBJZEZvckJ1bmRsZSIsImVuZHNXaXRoIiwiZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMiLCJidW5kbGVJZHMiLCJwcm94aWVkQXBwSWRzIiwicG9zc2libGVCdW5kbGVJZHMiLCJ1bmlxIiwiam9pbiIsImNoZWNrUGFyYW1zIiwicGFyYW1zIiwiZXJyb3JzIiwicGFyYW0iLCJ2YWx1ZSIsImFzc2VydCIsIm9rIiwiZXJyIiwibGVuZ3RoIiwid3JhcFNjcmlwdEZvckZyYW1lIiwic2NyaXB0IiwiZnJhbWUiLCJlbEZyb21DYWNoZSIsInRvU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldFNjcmlwdEZvckF0b20iLCJhdG9tIiwiYXJncyIsImZyYW1lcyIsImFzeW5jQ2FsbEJhY2siLCJhdG9tU3JjIiwibWFwIiwic2ltcGxlU3RyaW5naWZ5IiwibXVsdGlsaW5lIiwiY2xlYW5WYWx1ZSIsImNsb25lIiwicHJvcGVydHkiLCJkZWZlcnJlZFByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicHJvbWlzZSIsIkIiLCJyZXMiLCJyZWoiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJ0cnVuY2F0ZSIsInBhcnNlIiwiaXNPYmplY3QiLCJzdGF0dXMiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxxQkFBcUIsR0FBRyw2QkFBOUI7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRywyQkFBbEM7QUFDQSxNQUFNQyw4QkFBOEIsR0FBRyw2QkFBdkM7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxHQUEzQjtBQUdBLE1BQU1DLG1CQUFtQixHQUFHLENBQzFCLFlBRDBCLEVBRTFCLGdCQUYwQixFQUcxQixhQUgwQixDQUE1QjtBQU1BLE1BQU1DLG1CQUFtQixHQUFHLEdBQTVCOzs7QUFNQSxTQUFTQyxlQUFULENBQTBCQyxJQUExQixFQUFnQztBQUM5QixRQUFNQyxFQUFFLEdBQUdELElBQUksQ0FBQ0UsMkJBQWhCO0FBQ0EsUUFBTUMsT0FB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LE9BQXBDLEVBQTZDLFVBQTdDLENBQXZCLEVBQWlGO0FBQy9FLGFBQU92QixLQUFLLENBQUN1QixRQUFELENBQVo7QUFDRDtBQUNGOztBQUNELFNBQU92QixLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBnZXRBdG9tIGZyb20gJy4vYXRvbXMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuXG5jb25zdCBXRUJfQ09OVEVOVF9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLldlYktpdC5XZWJDb250ZW50JztcbmNvbnN0IFNBRkFSSV9XRUJfVklFV19CVU5ETEVfSUQgPSAncHJvY2Vzcy1TYWZhcmlWaWV3U2VydmljZSc7XG5jb25zdCBTQUZBUklfV0VCX1ZJRVdfRlVMTF9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLlNhZmFyaVZpZXdTZXJ2aWNlJztcbmNvbnN0IFdJTERDQVJEX0JVTkRMRV9JRCA9ICcqJztcblxuLy8gdmFsdWVzIGZvciB0aGUgcGFnZSBgV0lSVHlwZUtleWAgZW50cnlcbmNvbnN0IEFDQ0VQVEVEX1BBR0VfVFlQRVMgPSBbXG4gICdXSVJUeXBlV2ViJywgLy8gdXAgdG8gaU9TIDExLjNcbiAgJ1dJUlR5cGVXZWJQYWdlJywgLy8gaU9TIDExLjRcbiAgJ1dJUlR5cGVQYWdlJywgLy8gaU9TIDExLjQgd2Vidmlld1xuXTtcblxuY29uc3QgUkVTUE9OU0VfTE9HX0xFTkdUSCA9IDEwMDtcblxuLypcbiAqIFRha2VzIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IHdob3NlIGtleXMgYXJlIHVuZGVyc3RhbmRhYmxlXG4gKi9cbmZ1bmN0aW9uIGFwcEluZm9Gcm9tRGljdCAoZGljdCkge1xuICBjb25zdCBpZCA9IGRpY3QuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICBjb25zdCBpc1Byb3h5ID0gXy5pc1N0cmluZyhkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleSlcbiAgICA/IGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5LnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJ1xuICAgIDogZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXk7XG4gIC8vIGF1dG9tYXRpb24gZW5hYmxlZCBjYW4gYmUgZWl0aGVyIGZyb20gdGhlIGtleXNcbiAgLy8gICAtIFdJUlJlbW90ZUF1dG9tYXRpb25FbmFibGVkS2V5IChib29sZWFuKVxuICAvLyAgIC0gV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSAoc3RyaW5nIG9yIGJvb2xlYW4pXG4gIGxldCBpc0F1dG9tYXRpb25FbmFibGVkID0gISFkaWN0LldJUlJlbW90ZUF1dG9tYXRpb25FbmFibGVkS2V5O1xuICBpZiAoXy5oYXMoZGljdCwgJ1dJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXknKSkge1xuICAgIGlmIChfLmlzU3RyaW5nKGRpY3QuV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSkpIHtcbiAgICAgIGlzQXV0b21hdGlvbkVuYWJsZWQgPSBkaWN0LldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXkgPT09ICdXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5VW5rbm93bidcbiAgICAgICAgPyAnVW5rbm93bidcbiAgICAgICAgOiBkaWN0LldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXkgPT09ICdXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5QXZhaWxhYmxlJztcbiAgICB9IGVsc2Uge1xuICAgICAgaXNBdXRvbWF0aW9uRW5hYmxlZCA9ICEhZGljdC5XSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5S2V5O1xuICAgIH1cbiAgfVxuICBjb25zdCBlbnRyeSA9IHtcbiAgICBpZCxcbiAgICBpc1Byb3h5LFxuICAgIG5hbWU6IGRpY3QuV0lSQXBwbGljYXRpb25OYW1lS2V5LFxuICAgIGJ1bmRsZUlkOiBkaWN0LldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSxcbiAgICBob3N0SWQ6IGRpY3QuV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICBpc0FjdGl2ZTogZGljdC5XSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5LFxuICAgIGlzQXV0b21hdGlvbkVuYWJsZWQsXG4gIH07XG5cbiAgcmV0dXJuIFtpZCwgZW50cnldO1xufVxuXG4vKlxuICogVGFrZSBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSBvZiBwYWdlcyBhdmFpbGFibGUuXG4gKi9cbmZ1bmN0aW9uIHBhZ2VBcnJheUZyb21EaWN0IChwYWdlRGljdCkge1xuICBpZiAocGFnZURpY3QuaWQpIHtcbiAgICAvLyB0aGUgcGFnZSBpcyBhbHJlYWR5IHRyYW5zbGF0ZWQsIHNvIHdyYXAgaW4gYW4gYXJyYXkgYW5kIHBhc3MgYmFja1xuICAgIHJldHVybiBbcGFnZURpY3RdO1xuICB9XG4gIGxldCBuZXdQYWdlQXJyYXkgPSBbXTtcbiAgZm9yIChjb25zdCBkaWN0IG9mIF8udmFsdWVzKHBhZ2VEaWN0KSkge1xuICAgIC8vIGNvdW50IG9ubHkgV0lSVHlwZVdlYiBwYWdlcyBhbmQgaWdub3JlIGFsbCBvdGhlcnMgKFdJUlR5cGVKYXZhU2NyaXB0IGV0YylcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChkaWN0LldJUlR5cGVLZXkpIHx8IEFDQ0VQVEVEX1BBR0VfVFlQRVMuaW5jbHVkZXMoZGljdC5XSVJUeXBlS2V5KSkge1xuICAgICAgbmV3UGFnZUFycmF5LnB1c2goe1xuICAgICAgICBpZDogZGljdC5XSVJQYWdlSWRlbnRpZmllcktleSxcbiAgICAgICAgdGl0bGU6IGRpY3QuV0lSVGl0bGVLZXksXG4gICAgICAgIHVybDogZGljdC5XSVJVUkxLZXksXG4gICAgICAgIGlzS2V5OiAhXy5pc1VuZGVmaW5lZChkaWN0LldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5KSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3UGFnZUFycmF5O1xufVxuXG4vKlxuICogR2l2ZW4gYSBidW5kbGUgaWQsIGZpbmRzIHRoZSBjb3JyZWN0IHJlbW90ZSBkZWJ1Z2dlciBhcHAgdGhhdCBpc1xuICogY29ubmVjdGVkLlxuICovXG5mdW5jdGlvbiBnZXREZWJ1Z2dlckFwcEtleSAoYnVuZGxlSWQsIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkID09PSBidW5kbGVJZCkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICBpZiAoYXBwSWQpIHtcbiAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICBsZXQgcHJveHlBcHBJZDtcbiAgICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCBzZXBhcmF0ZSBidW5kbGVJZCAnJHtkYXRhLmJ1bmRsZUlkfScgYCArXG4gICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAvLyBzZXQgdGhlIGFwcCBpZC4uLiB0aGUgbGFzdCBvbmUgd2lsbCBiZSB1c2VkLCBzbyBqdXN0IGtlZXAgcmUtYXNzaWduaW5nXG4gICAgICAgIHByb3h5QXBwSWQgPSBrZXk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChwcm94eUFwcElkKSB7XG4gICAgICBhcHBJZCA9IHByb3h5QXBwSWQ7XG4gICAgICBsb2cuZGVidWcoYFVzaW5nIHByb3hpZWQgYXBwIGlkICcke2FwcElkfSdgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYXBwSWQ7XG59XG5cbmZ1bmN0aW9uIGFwcElkRm9yQnVuZGxlIChidW5kbGVJZCwgYXBwRGljdCkge1xuICBsZXQgYXBwSWQ7XG4gIGZvciAoY29uc3QgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgaWYgKGRhdGEuYnVuZGxlSWQuZW5kc1dpdGgoYnVuZGxlSWQpKSB7XG4gICAgICBhcHBJZCA9IGtleTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIC8vIGlmIG5vdGhpbmcgaXMgZm91bmQsIHRyeSB0byBnZXQgdGhlIGdlbmVyaWMgYXBwXG4gIGlmICghYXBwSWQgJiYgYnVuZGxlSWQgIT09IFdFQl9DT05URU5UX0JVTkRMRV9JRCkge1xuICAgIHJldHVybiBhcHBJZEZvckJ1bmRsZShXRUJfQ09OVEVOVF9CVU5ETEVfSUQsIGFwcERpY3QpO1xuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyAoYnVuZGxlSWRzLCBhcHBEaWN0KSB7XG4gIGxldCBwcm94aWVkQXBwSWRzID0gW107XG5cbiAgLy8gZ28gdGhyb3VnaCB0aGUgcG9zc2libGUgYnVuZGxlIGlkZW50aWZpZXJzXG4gIGNvbnN0IHBvc3NpYmxlQnVuZGxlSWRzID0gXy51bmlxKFtcbiAgICBTQUZBUklfV0VCX1ZJRVdfQlVORExFX0lELFxuICAgIFNBRkFSSV9XRUJfVklFV19GVUxMX0JVTkRMRV9JRCxcbiAgICBXSUxEQ0FSRF9CVU5ETEVfSUQsXG4gICAgLi4uYnVuZGxlSWRzLFxuICBdKTtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBmb3IgYnVuZGxlIGlkZW50aWZpZXJzOiAke3Bvc3NpYmxlQnVuZGxlSWRzLmpvaW4oJywgJyl9YCk7XG4gIGZvciAoY29uc3QgYnVuZGxlSWQgb2YgcG9zc2libGVCdW5kbGVJZHMpIHtcbiAgICBjb25zdCBhcHBJZCA9IGFwcElkRm9yQnVuZGxlKGJ1bmRsZUlkLCBhcHBEaWN0KTtcblxuICAgIC8vIG5vdyB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgcGljayBhIHByb3h5IGZvciB0aGlzIGluc3RlYWRcbiAgICBpZiAoYXBwSWQpIHtcbiAgICAgIHByb3hpZWRBcHBJZHMucHVzaChhcHBJZCk7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCBzZXBhcmF0ZSBidW5kbGVJZCAnJHtkYXRhLmJ1bmRsZUlkfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBhY3RpbmcgYXMgcHJveHkgZm9yICcke2J1bmRsZUlkfScsIHdpdGggYXBwIGlkICcke2tleX0nYCk7XG4gICAgICAgICAgcHJveGllZEFwcElkcy5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gXy51bmlxKHByb3hpZWRBcHBJZHMpO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1zKSB7XG4gIGxldCBlcnJvcnMgPSBbXTtcbiAgZm9yIChjb25zdCBbcGFyYW0sIHZhbHVlXSBvZiBfLnRvUGFpcnMocGFyYW1zKSkge1xuICAgIHRyeSB7XG4gICAgICBhc3NlcnQub2sodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZXJyb3JzLnB1c2gocGFyYW0pO1xuICAgIH1cbiAgfVxuICBpZiAoZXJyb3JzLmxlbmd0aCkge1xuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd3JhcFNjcmlwdEZvckZyYW1lIChzY3JpcHQsIGZyYW1lKSB7XG4gIGxvZy5kZWJ1ZyhgV3JhcHBpbmcgc2NyaXB0IGZvciBmcmFtZSAnJHtmcmFtZX0nYCk7XG4gIGxldCBlbEZyb21DYWNoZSA9IGF3YWl0IGdldEF0b20oJ2dldF9lbGVtZW50X2Zyb21fY2FjaGUnKTtcbiAgcmV0dXJuIGAoZnVuY3Rpb24gKHdpbmRvdykgeyB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7IGAgK1xuICAgICAgICAgYHJldHVybiAoJHtzY3JpcHR9KTsgfSkoKCR7ZWxGcm9tQ2FjaGUudG9TdHJpbmcoJ3V0ZjgnKX0pKCR7SlNPTi5zdHJpbmdpZnkoZnJhbWUpfSkpYDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2NyaXB0Rm9yQXRvbSAoYXRvbSwgYXJncywgZnJhbWVzLCBhc3luY0NhbGxCYWNrID0gbnVsbCkge1xuICBsZXQgYXRvbVNyYyA9IGF3YWl0IGdldEF0b20oYXRvbSk7XG4gIGxldCBzY3JpcHQ7XG4gIGlmIChmcmFtZXMubGVuZ3RoID4gMCkge1xuICAgIHNjcmlwdCA9IGF0b21TcmM7XG4gICAgZm9yIChjb25zdCBmcmFtZSBvZiBmcmFtZXMpIHtcbiAgICAgIHNjcmlwdCA9IGF3YWl0IHdyYXBTY3JpcHRGb3JGcmFtZShzY3JpcHQsIGZyYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJyR7YXRvbX0nIGF0b20gaW4gZGVmYXVsdCBjb250ZXh0YCk7XG4gICAgc2NyaXB0ID0gYCgke2F0b21TcmN9KWA7XG4gIH1cblxuICAvLyBhZGQgdGhlIGFyZ3VtZW50cywgYXMgc3RyaW5nc1xuICBhcmdzID0gYXJncy5tYXAoSlNPTi5zdHJpbmdpZnkpO1xuICBpZiAoYXN5bmNDYWxsQmFjaykge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9LCAke2FzeW5jQ2FsbEJhY2t9LCB0cnVlIClgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5mdW5jdGlvbiBzaW1wbGVTdHJpbmdpZnkgKHZhbHVlLCBtdWx0aWxpbmUgPSBmYWxzZSkge1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgfVxuXG4gIC8vIHdlIGdldCBiYWNrIG9iamVjdHMgc29tZXRpbWVzIHdpdGggc3RyaW5nIHZlcnNpb25zIG9mIGZ1bmN0aW9uc1xuICAvLyB3aGljaCBtdWRkeSB0aGUgbG9nc1xuICBsZXQgY2xlYW5WYWx1ZSA9IF8uY2xvbmUodmFsdWUpO1xuICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIFsnY2VpbCcsICdjbG9uZScsICdmbG9vcicsICdyb3VuZCcsICdzY2FsZScsICd0b1N0cmluZyddKSB7XG4gICAgZGVsZXRlIGNsZWFuVmFsdWVbcHJvcGVydHldO1xuICB9XG4gIHJldHVybiBtdWx0aWxpbmUgPyBKU09OLnN0cmluZ2lmeShjbGVhblZhbHVlLCBudWxsLCAyKSA6IEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUpO1xufVxuXG5mdW5jdGlvbiBkZWZlcnJlZFByb21pc2UgKCkge1xuICAvLyBodHRwOi8vYmx1ZWJpcmRqcy5jb20vZG9jcy9hcGkvZGVmZXJyZWQtbWlncmF0aW9uLmh0bWxcbiAgbGV0IHJlc29sdmU7XG4gIGxldCByZWplY3Q7XG4gIGNvbnN0IHByb21pc2UgPSBuZXcgQigocmVzLCByZWopID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3BhcmFtLW5hbWVzXG4gICAgcmVzb2x2ZSA9IHJlcztcbiAgICByZWplY3QgPSByZWo7XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIHByb21pc2UsXG4gICAgcmVzb2x2ZSxcbiAgICByZWplY3RcbiAgfTtcbn1cblxuZnVuY3Rpb24gY29udmVydFJlc3VsdCAocmVzKSB7XG4gIGlmIChfLmlzVW5kZWZpbmVkKHJlcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3QgZ2V0IE9LIHJlc3VsdCBmcm9tIHJlbW90ZSBkZWJ1Z2dlci4gUmVzdWx0IHdhczogJHtfLnRydW5jYXRlKHNpbXBsZVN0cmluZ2lmeShyZXMpLCB7bGVuZ3RoOiBSRVNQT05TRV9MT0dfTEVOR1RIfSl9YCk7XG4gIH0gZWxzZSBpZiAoXy5pc1N0cmluZyhyZXMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IEpTT04ucGFyc2UocmVzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHdlIG1pZ2h0IGdldCBhIHNlcmlhbGl6ZWQgb2JqZWN0LCBidXQgd2UgbWlnaHQgbm90XG4gICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgaXQgaXMganVzdCBhIHZhbHVlXG4gICAgfVxuICB9IGVsc2UgaWYgKCFfLmlzT2JqZWN0KHJlcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFJlc3VsdCBoYXMgdW5leHBlY3RlZCB0eXBlOiAoJHt0eXBlb2YgcmVzfSkuYCk7XG4gIH1cblxuICBpZiAocmVzLnN0YXR1cyAmJiByZXMuc3RhdHVzICE9PSAwKSB7XG4gICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICB0aHJvdyBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZShyZXMuc3RhdHVzLCByZXMudmFsdWUubWVzc2FnZSB8fCByZXMudmFsdWUpO1xuICB9XG5cbiAgLy8gd2l0aCBlaXRoZXIgaGF2ZSBhbiBvYmplY3Qgd2l0aCBhIGB2YWx1ZWAgcHJvcGVydHkgKGV2ZW4gaWYgYG51bGxgKSxcbiAgLy8gb3IgYSBwbGFpbiBvYmplY3RcbiAgbGV0IHZhbHVlID0gXy5oYXMocmVzLCAndmFsdWUnKSA/IHJlcy52YWx1ZSA6IHJlcztcblxuICAvLyBnZXQgcmlkIG9mIG5vaXN5IGZ1bmN0aW9ucyBvbiBvYmplY3RzXG4gIGlmIChfLmlzT2JqZWN0KHZhbHVlKSkge1xuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgWydjZWlsJywgJ2Nsb25lJywgJ2Zsb29yJywgJ3JvdW5kJywgJ3NjYWxlJywgJ3RvU3RyaW5nJ10pIHtcbiAgICAgIGRlbGV0ZSB2YWx1ZVtwcm9wZXJ0eV07XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuZXhwb3J0IHtcbiAgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksXG4gIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcywgd3JhcFNjcmlwdEZvckZyYW1lLCBnZXRTY3JpcHRGb3JBdG9tLFxuICBzaW1wbGVTdHJpbmdpZnksIGRlZmVycmVkUHJvbWlzZSwgY29udmVydFJlc3VsdCwgUkVTUE9OU0VfTE9HX0xFTkdUSCxcbn07XG4iXSwiZmlsZSI6ImxpYi9oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
